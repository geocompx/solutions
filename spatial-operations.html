<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<base href="https://r.geocompx.org/solutions/">
<title>Chapter 4 Spatial data operations | Geocomputation with R: Solutions</title>
<meta name="author" content="Robin Lovelace, Jakub Nowosad, Jannes Muenchow">
<meta name="description" content="library(sf) library(dplyr) library(spData) E1. It was established in Section ?? that Canterbury was the region of New Zealand containing most of the 100 highest points in the country. How many of...">
<meta name="generator" content="bookdown 0.32 with bs4_book()">
<meta property="og:title" content="Chapter 4 Spatial data operations | Geocomputation with R: Solutions">
<meta property="og:type" content="book">
<meta property="og:url" content="https://r.geocompx.org/solutions/spatial-operations.html">
<meta property="og:image" content="https://r.geocompx.org/solutions/images/cover.png">
<meta property="og:description" content="library(sf) library(dplyr) library(spData) E1. It was established in Section ?? that Canterbury was the region of New Zealand containing most of the 100 highest points in the country. How many of...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 4 Spatial data operations | Geocomputation with R: Solutions">
<meta name="twitter:description" content="library(sf) library(dplyr) library(spData) E1. It was established in Section ?? that Canterbury was the region of New Zealand containing most of the 100 highest points in the country. How many of...">
<meta name="twitter:image" content="https://r.geocompx.org/solutions/images/cover.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><link href="libs/Lato-0.4.5/font.css" rel="stylesheet">
<link href="libs/Roboto_Mono-0.4.5/font.css" rel="stylesheet">
<link href="libs/Montserrat-0.4.5/font.css" rel="stylesheet">
<script src="libs/bs3compat-0.4.2/transition.js"></script><script src="libs/bs3compat-0.4.2/tabs.js"></script><script src="libs/bs3compat-0.4.2/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h2>
        <a href="index.html" title="">Geocomputation with R: Solutions</a>
      </h2>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="intro.html"><span class="header-section-number">1</span> Introduction</a></li>
<li class="book-part">Foundations</li>
<li><a class="" href="spatial-class.html"><span class="header-section-number">2</span> Geographic data in R</a></li>
<li><a class="" href="attr.html"><span class="header-section-number">3</span> Attribute data operations</a></li>
<li><a class="active" href="spatial-operations.html"><span class="header-section-number">4</span> Spatial data operations</a></li>
<li><a class="" href="geometric-operations.html"><span class="header-section-number">5</span> Geometry operations</a></li>
<li><a class="" href="raster-vector.html"><span class="header-section-number">6</span> Raster-vector interactions</a></li>
<li><a class="" href="reproj-geo-data.html"><span class="header-section-number">7</span> Reprojecting geographic data</a></li>
<li><a class="" href="read-write.html"><span class="header-section-number">8</span> Geographic data I/O</a></li>
<li class="book-part">Extensions</li>
<li><a class="" href="adv-map.html"><span class="header-section-number">9</span> Making maps with R</a></li>
<li><a class="" href="gis.html"><span class="header-section-number">10</span> Bridges to GIS software</a></li>
<li><a class="" href="spatial-cv.html"><span class="header-section-number">11</span> Statistical learning</a></li>
<li class="book-part">Applications</li>
<li><a class="" href="transport.html"><span class="header-section-number">12</span> Transportation</a></li>
<li><a class="" href="location.html"><span class="header-section-number">13</span> Geomarketing</a></li>
<li><a class="" href="eco.html"><span class="header-section-number">14</span> Ecology</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/geocompx/solutions">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="spatial-operations" class="section level1" number="4">
<h1>
<span class="header-section-number">4</span> Spatial data operations<a class="anchor" aria-label="anchor" href="#spatial-operations"><i class="fas fa-link"></i></a>
</h1>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://jakubnowosad.com/spData/">spData</a></span><span class="op">)</span></span></code></pre></div>
<p>E1. It was established in Section <a href="#spatial-vec"><strong>??</strong></a> that Canterbury was the region of New Zealand containing most of the 100 highest points in the country.
How many of these high points does the Canterbury region contain?</p>
<p><strong>Bonus:</strong> plot the result using the <code><a href="https://rdrr.io/pkg/terra/man/plot.html">plot()</a></code> function to show all of New Zealand, <code>canterbury</code> region highlighted in yellow, high points in Canterbury represented by red crosses (hint: <code>pch = 7</code>) and high points in other parts of New Zealand represented by blue circles. See the help page <code><a href="https://rdrr.io/pkg/terra/man/lines.html">?points</a></code> for details with an illustration of different <code>pch</code> values.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-tmap/tmap">tmap</a></span><span class="op">)</span></span>
<span><span class="co"># tmap_mode("view")</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/qtm.html">qtm</a></span><span class="op">(</span><span class="va">nz</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/qtm.html">qtm</a></span><span class="op">(</span><span class="va">nz_height</span><span class="op">)</span></span>
<span><span class="va">canterbury</span> <span class="op">=</span> <span class="va">nz</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Name</span> <span class="op">==</span> <span class="st">"Canterbury"</span><span class="op">)</span></span>
<span><span class="va">canterbury_height</span> <span class="op">=</span> <span class="va">nz_height</span><span class="op">[</span><span class="va">canterbury</span>, <span class="op">]</span></span>
<span><span class="va">nz_not_canterbury_height</span> <span class="op">=</span> <span class="va">nz_height</span><span class="op">[</span><span class="va">canterbury</span>, , op <span class="op">=</span> <span class="va">st_disjoint</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/dimensions.html">nrow</a></span><span class="op">(</span><span class="va">canterbury_height</span><span class="op">)</span> <span class="co"># answer: 70</span></span>
<span><span class="co">#&gt; [1] 70</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">nz</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">canterbury</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"yellow"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">nz_not_canterbury_height</span><span class="op">$</span><span class="va">geometry</span>, pch <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"blue"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">canterbury_height</span><span class="op">$</span><span class="va">geometry</span>, pch <span class="op">=</span> <span class="fl">4</span>, col <span class="op">=</span> <span class="st">"red"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="04-spatial-operations_files/figure-html/04-ex-e1-1.png" width="100%" style="display: block; margin: auto;"><img src="04-spatial-operations_files/figure-html/04-ex-e1-2.png" width="100%" style="display: block; margin: auto;"></p>
<p>E2. Which region has the second highest number of <code>nz_height</code> points, and how many does it have?</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nz_height_count</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">nz_height</span>, <span class="va">nz</span>, <span class="va">length</span><span class="op">)</span></span>
<span><span class="va">nz_height_combined</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">nz</span>, count <span class="op">=</span> <span class="va">nz_height_count</span><span class="op">$</span><span class="va">elevation</span><span class="op">)</span></span>
<span><span class="va">nz_height_combined</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">Name</span>, <span class="va">count</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt;         Name count</span></span>
<span><span class="co">#&gt; 1 West Coast    22</span></span></code></pre></div>
<p>E3. Generalizing the question to all regions: how many of New Zealandâ€™s 16 regions contain points which belong to the top 100 highest points in the country? Which regions?</p>
<ul>
<li>Bonus: create a table listing these regions in order of the number of points and their name.</li>
</ul>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Base R way:</span></span>
<span><span class="va">nz_height_count</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">nz_height</span>, <span class="va">nz</span>, <span class="va">length</span><span class="op">)</span></span>
<span><span class="va">nz_height_combined</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">nz</span>, count <span class="op">=</span> <span class="va">nz_height_count</span><span class="op">$</span><span class="va">elevation</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">nz_height_combined</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Tidyverse way:</span></span>
<span><span class="va">nz_height_joined</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_join</a></span><span class="op">(</span><span class="va">nz_height</span>, <span class="va">nz</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">Name</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Calculate n. points in each region - this contains the result</span></span>
<span><span class="va">nz_height_counts</span> <span class="op">=</span> <span class="va">nz_height_joined</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Name</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>count <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Optionally join results with nz geometries:</span></span>
<span><span class="va">nz_height_combined</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">nz</span>, <span class="va">nz_height_counts</span> <span class="op">|&gt;</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(Name)`</span></span>
<span><span class="co"># plot(nz_height_combined) # Check: results identical to base R result</span></span>
<span></span>
<span><span class="co"># Generate a summary table</span></span>
<span><span class="va">nz_height_combined</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">Name</span>, <span class="va">count</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;                Name count</span></span>
<span><span class="co">#&gt; 1        Canterbury    70</span></span>
<span><span class="co">#&gt; 2        West Coast    22</span></span>
<span><span class="co">#&gt; 3           Waikato     3</span></span>
<span><span class="co">#&gt; 4 Manawatu-Wanganui     2</span></span>
<span><span class="co">#&gt; 5             Otago     2</span></span>
<span><span class="co">#&gt; 6         Southland     1</span></span>
<span><span class="co">#&gt; 7       Marlborough     1</span></span></code></pre></div>
<div class="inline-figure"><img src="04-spatial-operations_files/figure-html/04-ex-e3-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>E4. Test your knowledge of spatial predicates by finding out and plotting how US states relate to each other and other spatial objects.</p>
<p>The starting point of this exercise is to create an object representing Colorado state in the USA. Do this with the command
<code>colorado = us_states[us_states$NAME == "Colorado",]</code> (base R) or with with the <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> function (tidyverse) and plot the resulting object in the context of US states.</p>
<ul>
<li>Create a new object representing all the states that geographically intersect with Colorado and plot the result (hint: the most concise way to do this is with the subsetting method <code>[</code>).</li>
<li>Create another object representing all the objects that touch (have a shared boundary with) Colorado and plot the result (hint: remember you can use the argument <code>op = st_intersects</code> and other spatial relations during spatial subsetting operations in base R).</li>
<li>Bonus: create a straight line from the centroid of the District of Columbia near the East coast to the centroid of California near the West coast of the USA (hint: functions <code><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_centroid()</a></code>, <code><a href="https://r-spatial.github.io/sf/reference/geos_combine.html">st_union()</a></code> and <code><a href="https://r-spatial.github.io/sf/reference/st_cast.html">st_cast()</a></code> described in Chapter 5 may help) and identify which states this long East-West line crosses.</li>
</ul>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">colorado</span> <span class="op">=</span> <span class="va">us_states</span><span class="op">[</span><span class="va">us_states</span><span class="op">$</span><span class="va">NAME</span> <span class="op">==</span> <span class="st">"Colorado"</span>, <span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">us_states</span><span class="op">$</span><span class="va">geometry</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">colorado</span><span class="op">$</span><span class="va">geometry</span>, col <span class="op">=</span> <span class="st">"grey"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="04-spatial-operations_files/figure-html/04-ex-4-1-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">intersects_with_colorado</span> <span class="op">=</span> <span class="va">us_states</span><span class="op">[</span><span class="va">colorado</span>, , op <span class="op">=</span> <span class="va">st_intersects</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">us_states</span><span class="op">$</span><span class="va">geometry</span>, main <span class="op">=</span> <span class="st">"States that intersect with Colorado"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">intersects_with_colorado</span><span class="op">$</span><span class="va">geometry</span>, col <span class="op">=</span> <span class="st">"grey"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="04-spatial-operations_files/figure-html/04-ex-4-2-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Alternative but more verbose solutions</span></span>
<span><span class="co"># 2: With intermediate object, one list for each state</span></span>
<span><span class="va">sel_intersects_colorado</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_intersects</a></span><span class="op">(</span><span class="va">us_states</span>, <span class="va">colorado</span><span class="op">)</span></span>
<span><span class="va">sel_intersects_colorado_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lengths.html">lengths</a></span><span class="op">(</span><span class="va">sel_intersects_colorado</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span></span>
<span><span class="va">intersects_with_colorado</span> <span class="op">=</span> <span class="va">us_states</span><span class="op">[</span><span class="va">sel_intersects_colorado_list</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># 3: With intermediate object, one index for each state</span></span>
<span><span class="va">sel_intersects_colorado2</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_intersects</a></span><span class="op">(</span><span class="va">colorado</span>, <span class="va">us_states</span><span class="op">)</span></span>
<span><span class="va">sel_intersects_colorado2</span></span>
<span><span class="co">#&gt; Sparse geometry binary predicate list of length 1, where the predicate</span></span>
<span><span class="co">#&gt; was `intersects'</span></span>
<span><span class="co">#&gt;  1: 2, 3, 9, 19, 37, 39, 45, 49</span></span>
<span><span class="va">us_states</span><span class="op">$</span><span class="va">NAME</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">sel_intersects_colorado2</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] "Arizona"    "Colorado"   "Kansas"     "Oklahoma"   "Nebraska"  </span></span>
<span><span class="co">#&gt; [6] "New Mexico" "Utah"       "Wyoming"</span></span>
<span></span>
<span><span class="co"># 4: With tidyverse</span></span>
<span><span class="va">us_states</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_filter</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">colorado</span>, .predicate <span class="op">=</span> <span class="va">st_intersects</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 8 features and 6 fields</span></span>
<span><span class="co">#&gt; Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -115 ymin: 31.3 xmax: -94.4 ymax: 45</span></span>
<span><span class="co">#&gt; Geodetic CRS:  NAD83</span></span>
<span><span class="co">#&gt;   GEOID       NAME  REGION          AREA total_pop_10 total_pop_15</span></span>
<span><span class="co">#&gt; 1    04    Arizona    West 295281 [km^2]      6246816      6641928</span></span>
<span><span class="co">#&gt; 2    08   Colorado    West 269573 [km^2]      4887061      5278906</span></span>
<span><span class="co">#&gt; 3    20     Kansas Midwest 213037 [km^2]      2809329      2892987</span></span>
<span><span class="co">#&gt; 4    40   Oklahoma   South 180971 [km^2]      3675339      3849733</span></span>
<span><span class="co">#&gt; 5    31   Nebraska Midwest 200272 [km^2]      1799125      1869365</span></span>
<span><span class="co">#&gt; 6    35 New Mexico    West 314886 [km^2]      2013122      2084117</span></span>
<span><span class="co">#&gt; 7    49       Utah    West 219860 [km^2]      2657236      2903379</span></span>
<span><span class="co">#&gt; 8    56    Wyoming    West 253310 [km^2]       545579       579679</span></span>
<span><span class="co">#&gt;                         geometry</span></span>
<span><span class="co">#&gt; 1 MULTIPOLYGON (((-115 32.7, ...</span></span>
<span><span class="co">#&gt; 2 MULTIPOLYGON (((-109 41, -1...</span></span>
<span><span class="co">#&gt; 3 MULTIPOLYGON (((-102 40, -1...</span></span>
<span><span class="co">#&gt; 4 MULTIPOLYGON (((-103 37, -1...</span></span>
<span><span class="co">#&gt; 5 MULTIPOLYGON (((-104 43, -1...</span></span>
<span><span class="co">#&gt; 6 MULTIPOLYGON (((-109 37, -1...</span></span>
<span><span class="co">#&gt; 7 MULTIPOLYGON (((-114 42, -1...</span></span>
<span><span class="co">#&gt; 8 MULTIPOLYGON (((-104 45, -1...</span></span>
<span><span class="va">touches_colorado</span> <span class="op">=</span> <span class="va">us_states</span><span class="op">[</span><span class="va">colorado</span>, , op <span class="op">=</span> <span class="va">st_touches</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">us_states</span><span class="op">$</span><span class="va">geometry</span>, main <span class="op">=</span> <span class="st">"States that touch Colorado"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">touches_colorado</span><span class="op">$</span><span class="va">geometry</span>, col <span class="op">=</span> <span class="st">"grey"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="04-spatial-operations_files/figure-html/04-ex-4-4-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">washington_to_cali</span> <span class="op">=</span> <span class="va">us_states</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"Columbia|Cali"</span>, x <span class="op">=</span> <span class="va">NAME</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_centroid</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html">st_union</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html">st_cast</a></span><span class="op">(</span><span class="st">"LINESTRING"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in st_centroid.sf(filter(us_states, grepl(pattern = "Columbia|Cali", :</span></span>
<span><span class="co">#&gt; st_centroid assumes attributes are constant over geometries of x</span></span>
<span><span class="va">states_crossed</span> <span class="op">=</span> <span class="va">us_states</span><span class="op">[</span><span class="va">washington_to_cali</span>, , op <span class="op">=</span> <span class="va">st_crosses</span><span class="op">]</span></span>
<span><span class="co">#&gt; although coordinates are longitude/latitude, st_crosses assumes that they are</span></span>
<span><span class="co">#&gt; planar</span></span>
<span><span class="va">states_crossed</span><span class="op">$</span><span class="va">NAME</span></span>
<span><span class="co">#&gt;  [1] "Colorado"             "Indiana"              "Kansas"              </span></span>
<span><span class="co">#&gt;  [4] "Missouri"             "Nevada"               "West Virginia"       </span></span>
<span><span class="co">#&gt;  [7] "California"           "District of Columbia" "Illinois"            </span></span>
<span><span class="co">#&gt; [10] "Kentucky"             "Ohio"                 "Utah"                </span></span>
<span><span class="co">#&gt; [13] "Virginia"</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">us_states</span><span class="op">$</span><span class="va">geometry</span>, main <span class="op">=</span> <span class="st">"States crossed by a straight line\n from the District of Columbia to central California"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">states_crossed</span><span class="op">$</span><span class="va">geometry</span>, col <span class="op">=</span> <span class="st">"grey"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">washington_to_cali</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="04-spatial-operations_files/figure-html/04-ex-4-5-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>E5. Use <code>dem = rast(system.file("raster/dem.tif", package = "spDataLarge"))</code>, and reclassify the elevation in three classes: low (&lt;300), medium and high (&gt;500).
Secondly, read the NDVI raster (<code>ndvi = rast(system.file("raster/ndvi.tif", package = "spDataLarge"))</code>) and compute the mean NDVI and the mean elevation for each altitudinal class.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/terra/">terra</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; terra 1.7.3</span></span>
<span><span class="va">dem</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"raster/dem.tif"</span>, package <span class="op">=</span> <span class="st">"spDataLarge"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ndvi</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"raster/ndvi.tif"</span>, package <span class="op">=</span> <span class="st">"spDataLarge"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#1</span></span>
<span><span class="va">dem_rcl</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">300</span>, <span class="fl">0</span>, <span class="fl">300</span>, <span class="fl">500</span>, <span class="fl">1</span>, <span class="fl">500</span>, <span class="cn">Inf</span>, <span class="fl">2</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">3</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">dem_reclass</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/classify.html">classify</a></span><span class="op">(</span><span class="va">dem</span>, <span class="va">dem_rcl</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/factors.html">levels</a></span><span class="op">(</span><span class="va">dem_reclass</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">2</span>, cats <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"low"</span>, <span class="st">"medium"</span>, <span class="st">"high"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">dem_reclass</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#2</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/zonal.html">zonal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">dem</span>, <span class="va">ndvi</span><span class="op">)</span>, <span class="va">dem_reclass</span>, fun <span class="op">=</span> <span class="st">"mean"</span><span class="op">)</span></span>
<span><span class="co">#&gt;     cats dem   ndvi</span></span>
<span><span class="co">#&gt; 1    low 274 -0.363</span></span>
<span><span class="co">#&gt; 2 medium 392 -0.289</span></span>
<span><span class="co">#&gt; 3   high 765 -0.208</span></span></code></pre></div>
<div class="inline-figure"><img src="04-spatial-operations_files/figure-html/04-ex-e5-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>E6. Apply a line detection filter to <code>rast(system.file("ex/logo.tif", package = "terra"))</code>.
Plot the result.
Hint: Read <code>?terra::focal()</code>.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># from the focal help page (?terra::focal()):</span></span>
<span><span class="co"># Laplacian filter: filter=matrix(c(0,1,0,1,-4,1,0,1,0), nrow=3)</span></span>
<span><span class="co"># Sobel filters (for edge detection): </span></span>
<span><span class="co"># fx=matrix(c(-1,-2,-1,0,0,0,1,2,1), nrow=3) </span></span>
<span><span class="co"># fy=matrix(c(1,0,-1,2,0,-2,1,0,-1), nrow=3)</span></span>
<span></span>
<span><span class="co"># just retrieve the first channel of the R logo</span></span>
<span><span class="va">r</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"ex/logo.tif"</span>, package <span class="op">=</span> <span class="st">"terra"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># compute the Sobel filter</span></span>
<span><span class="va">filter_x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">2</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">sobel_x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/focal.html">focal</a></span><span class="op">(</span><span class="va">r</span>, w <span class="op">=</span> <span class="va">filter_x</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">sobel_x</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"white"</span>, <span class="st">"black"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">filter_y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">sobel_y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/focal.html">focal</a></span><span class="op">(</span><span class="va">r</span>, w <span class="op">=</span> <span class="va">filter_y</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">sobel_y</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"white"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="04-spatial-operations_files/figure-html/04-ex-e6-1.png" width="100%" style="display: block; margin: auto;"><img src="04-spatial-operations_files/figure-html/04-ex-e6-2.png" width="100%" style="display: block; margin: auto;"></p>
<p>E7. Calculate the Normalized Difference Water Index (NDWI; <code>(green - nir)/(green + nir)</code>) of a Landsat image.
Use the Landsat image provided by the <strong>spDataLarge</strong> package (<code>system.file("raster/landsat.tif", package = "spDataLarge")</code>).
Also, calculate a correlation between NDVI and NDWI for this area (hint: you can use the <code><a href="https://rdrr.io/pkg/terra/man/layerCor.html">layerCor()</a></code> function).</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"raster/landsat.tif"</span>, package <span class="op">=</span> <span class="st">"spDataLarge"</span><span class="op">)</span></span>
<span><span class="va">multi_rast</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span><span class="va">file</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ndvi_fun</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">nir</span>, <span class="va">red</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="op">(</span><span class="va">nir</span> <span class="op">-</span> <span class="va">red</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">nir</span> <span class="op">+</span> <span class="va">red</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">ndvi_rast</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/lapp.html">lapp</a></span><span class="op">(</span><span class="va">multi_rast</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">3</span><span class="op">)</span><span class="op">]</span><span class="op">]</span>, fun <span class="op">=</span> <span class="va">ndvi_fun</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">ndvi_rast</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ndwi_fun</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">green</span>, <span class="va">nir</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="op">(</span><span class="va">green</span> <span class="op">-</span> <span class="va">nir</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">green</span> <span class="op">+</span> <span class="va">nir</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">ndwi_rast</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/lapp.html">lapp</a></span><span class="op">(</span><span class="va">multi_rast</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span><span class="op">]</span><span class="op">]</span>, fun <span class="op">=</span> <span class="va">ndwi_fun</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">ndwi_rast</span><span class="op">)</span></span>
<span></span>
<span><span class="va">two_rasts</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ndvi_rast</span>, <span class="va">ndwi_rast</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">two_rasts</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ndvi"</span>, <span class="st">"ndwi"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># correlation -- option 1</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/layerCor.html">layerCor</a></span><span class="op">(</span><span class="va">two_rasts</span>, fun <span class="op">=</span> <span class="va">cor</span><span class="op">)</span></span>
<span><span class="co">#&gt;        ndvi   ndwi</span></span>
<span><span class="co">#&gt; ndvi  1.000 -0.913</span></span>
<span><span class="co">#&gt; ndwi -0.913  1.000</span></span>
<span></span>
<span><span class="co"># correlation -- option 2</span></span>
<span><span class="va">two_rasts_df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">two_rasts</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="va">two_rasts_df</span><span class="op">$</span><span class="va">ndvi</span>, <span class="va">two_rasts_df</span><span class="op">$</span><span class="va">ndwi</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -0.913</span></span></code></pre></div>
<p><img src="04-spatial-operations_files/figure-html/04-ex-e7-1.png" width="100%" style="display: block; margin: auto;"><img src="04-spatial-operations_files/figure-html/04-ex-e7-2.png" width="100%" style="display: block; margin: auto;"></p>
<p>E8. A StackOverflow <a href="https://stackoverflow.com/questions/35555709/global-raster-of-geographic-distances">post</a> shows how to compute distances to the nearest coastline using <code><a href="https://rdrr.io/pkg/terra/man/distance.html">raster::distance()</a></code>.
Try to do something similar but with <code><a href="https://rdrr.io/pkg/terra/man/distance.html">terra::distance()</a></code>: retrieve a digital elevation model of Spain, and compute a raster which represents distances to the coast across the country (hint: use <code><a href="https://rdrr.io/pkg/geodata/man/elevation.html">geodata::elevation_30s()</a></code>).
Convert the resulting distances from meters to kilometers.
Note: it may be wise to increase the cell size of the input raster to reduce compute time during this operation (<code><a href="https://rdrr.io/pkg/terra/man/aggregate.html">aggregate()</a></code>).</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="spatial-operations.html#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch the DEM data for Spain</span></span>
<span id="cb37-2"><a href="spatial-operations.html#cb37-2" aria-hidden="true" tabindex="-1"></a>spain_dem <span class="ot">=</span> geodata<span class="sc">::</span><span class="fu">elevation_30s</span>(<span class="at">country =</span> <span class="st">"Spain"</span>, <span class="at">path =</span> <span class="st">"."</span>, <span class="at">mask =</span> <span class="cn">FALSE</span>)</span>
<span id="cb37-3"><a href="spatial-operations.html#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="spatial-operations.html#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Reduce the resolution by a factor of 20 to speed up calculations</span></span>
<span id="cb37-5"><a href="spatial-operations.html#cb37-5" aria-hidden="true" tabindex="-1"></a>spain_dem <span class="ot">=</span> <span class="fu">aggregate</span>(spain_dem, <span class="at">fact =</span> <span class="dv">20</span>)</span>
<span id="cb37-6"><a href="spatial-operations.html#cb37-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-7"><a href="spatial-operations.html#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="co"># According to the documentation, terra::distance() will calculate distance</span></span>
<span id="cb37-8"><a href="spatial-operations.html#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co"># for all cells that are NA to the nearest cell that are not NA. To calculate</span></span>
<span id="cb37-9"><a href="spatial-operations.html#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="co"># distance to the coast, we need a raster that has NA values over land and any</span></span>
<span id="cb37-10"><a href="spatial-operations.html#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="co"># other value over water</span></span>
<span id="cb37-11"><a href="spatial-operations.html#cb37-11" aria-hidden="true" tabindex="-1"></a>water_mask <span class="ot">=</span> <span class="fu">is.na</span>(spain_dem)</span>
<span id="cb37-12"><a href="spatial-operations.html#cb37-12" aria-hidden="true" tabindex="-1"></a>water_mask[water_mask <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">=</span> <span class="cn">NA</span></span>
<span id="cb37-13"><a href="spatial-operations.html#cb37-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-14"><a href="spatial-operations.html#cb37-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the distance() function on this mask to get distance to the coast</span></span>
<span id="cb37-15"><a href="spatial-operations.html#cb37-15" aria-hidden="true" tabindex="-1"></a>distance_to_coast <span class="ot">=</span> <span class="fu">distance</span>(water_mask)</span>
<span id="cb37-16"><a href="spatial-operations.html#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb37-17"><a href="spatial-operations.html#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="sc">|---------</span><span class="er">|</span><span class="sc">---------</span><span class="er">|</span><span class="sc">---------</span><span class="er">|</span><span class="sc">---------</span><span class="er">|</span></span>
<span id="cb37-18"><a href="spatial-operations.html#cb37-18" aria-hidden="true" tabindex="-1"></a><span class="er">=========================================</span></span>
<span id="cb37-19"><a href="spatial-operations.html#cb37-19" aria-hidden="true" tabindex="-1"></a>                                          </span>
<span id="cb37-20"><a href="spatial-operations.html#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="co"># convert distance into km</span></span>
<span id="cb37-21"><a href="spatial-operations.html#cb37-21" aria-hidden="true" tabindex="-1"></a>distance_to_coast_km <span class="ot">=</span> distance_to_coast <span class="sc">/</span> <span class="dv">1000</span></span>
<span id="cb37-22"><a href="spatial-operations.html#cb37-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-23"><a href="spatial-operations.html#cb37-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the result</span></span>
<span id="cb37-24"><a href="spatial-operations.html#cb37-24" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(distance_to_coast_km, <span class="at">main =</span> <span class="st">"Distance to the coast (km)"</span>)</span></code></pre></div>
<div class="inline-figure"><img src="04-spatial-operations_files/figure-html/04-ex-e8-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>E9. Try to modify the approach used in the above exercise by weighting the distance raster with the elevation raster; every 100 altitudinal meters should increase the distance to the coast by 10 km.
Next, compute and visualize the difference between the raster created using the Euclidean distance (E7) and the raster weighted by elevation.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># now let's weight each 100 altitudinal meters by an additional distance of 10 km</span></span>
<span><span class="va">distance_to_coast_km2</span> <span class="op">=</span> <span class="va">distance_to_coast_km</span> <span class="op">+</span> <span class="op">(</span><span class="op">(</span><span class="va">spain_dem</span> <span class="op">/</span> <span class="fl">100</span><span class="op">)</span> <span class="op">*</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co"># plot the result</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">distance_to_coast_km2</span><span class="op">)</span></span>
<span><span class="co"># visualize the difference</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">distance_to_coast_km</span> <span class="op">-</span> <span class="va">distance_to_coast_km2</span><span class="op">)</span></span></code></pre></div>
<p><img src="04-spatial-operations_files/figure-html/04-ex-e9-1.png" width="100%" style="display: block; margin: auto;"><img src="04-spatial-operations_files/figure-html/04-ex-e9-2.png" width="100%" style="display: block; margin: auto;"></p>

</div>
  <div class="chapter-nav">
<div class="prev"><a href="attr.html"><span class="header-section-number">3</span> Attribute data operations</a></div>
<div class="next"><a href="geometric-operations.html"><span class="header-section-number">5</span> Geometry operations</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <h2>Note: Second Edition is under construction ðŸ—</h2>
    <!--<p>Now is a great time to provide feedback</p>-->
        <ul class="list-unstyled">
<li><a href="https://discord.gg/PMztXYgNxp">Chat on Discord <i class="fab fa-discord"></i></a></li>
          <li><a href="https://supportukrainenow.org/">Support Ukraine ðŸ‡ºðŸ‡¦
</a></li>
        </ul>
<hr>
<nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav"><li><a class="nav-link" href="#spatial-operations"><span class="header-section-number">4</span> Spatial data operations</a></li></ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/geocompx/solutions/blob/main/04-spatial-operations.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/geocompx/solutions/edit/main/04-spatial-operations.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Geocomputation with R: Solutions</strong>" was written by Robin Lovelace, Jakub Nowosad, Jannes Muenchow. It was last built on 2023-02-05.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
